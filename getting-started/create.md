## Creating Infrastructure

### Configuration

The first step to creating infrastructure is to define your project configuration and global resources in the `network.yml` file. The following example configurations will use AWS as the cloud provider. Configuration for Rackspace is similar.

For this example we'll launch a single EC2 instance in the us-east-1 region.

The most basic `network.yml` is shown below. It defines the project, the cloud provider you want to use and what region you would like to run your cloud resources.

```yaml
name: example_project
internalDomain: example.internal
serial: 1

clouds:
  - cloud: ec2
    regions:
      - name: us-east-1
        cidr: 10.0.0.0/16
        
        zones:
          - name: us-east-1a
            subnets:
              - types: [public]
                cidr: 10.0.0.0/26
                	publicAccessible: true
```

The `name` attribute is the name of this instrastructure project. This name will be used throughout Beam to name cloud resources. Each resource Beam controls will have a tag, `beam.project`, with this name.

The `serial` attribute is the current unique version of this infrastructure. Serial can used to launch an identical infrastructure without interfering with already running infrastructure for this project. We'll see how this is used later to launch testing infrastructure. Each resource Beam controls will have a tag, `beam.serial`, with this name.

The `internalDomain` attribute defines the domain used by Beam service discovery. When set Beam will display the hostname that will be generated by service discovery in all output. _This is currently required even if service discovery is not used._

The `clouds` list defines each cloud provider that will be used to create cloud resources. Use `ec2` for AWS resources and `openstack` for Rackspace.

The `regions` list is used to define VPCs using the provided region and CIDR, in this case it will create a VPC in the `us-east-1` region with a CIDR of `10.0.0.0/16`. Beam will name the VPC based on the project information.

The `zones` list is used to define zones within a VPC. Each zone must have one or more `subnets`.

The `subnets` list defines subnets within a zone. The `types` attribute is an array of names for a subnet. These names act as tags that will be used later to reference the subnets. The `cidr` defines the network addresses for a subnet. This `cidr` should be contained within the `region` cidr. The `publicAccessible` attribute defines whether instances launched into the subnet will automatically get a publicly accessible IP.

After defining `network.yml` we need to define an environment. Environments are named after the file they are defined in. Let's create a dev environment by creating a file named `dev.yml` with the following configuration:

```yaml
network: network.yml

layers:
  - name: development
    image: ubuntu/images/hvm-ssd/ubuntu-trusty-14.04-amd64-server-20151019
    instanceType: t2.micro

    placements:
      - subnetType: public
        sizePerSubnet: 1
```

The `network` attribute defines the location of the `network.yml` file this environment is associated with.

The `layers` list defines each layer that makes of the environment. A layer is a group of identical cloud instances.

The `name` attribute defines the name of the layer. Each instance in a layer will have a tag, `beam.layer`, with this name.

The `image` attribute defines the machine image to launch a layer with. Either the name or ami-id can be provided.

The `instanceType` attribute defines the type of instance to launch a layer with. These types map one to one with EC2 instance type names.

The `placements` list defines where instances in a layer will be launched. The `subnetType` name corresponds to the subnets defined in `network.yml`. The number of instances to launch is controlled by `sizePerSubnet`. In this example for every subnet with the name `public` an instance will be launched.

### Launch Infrastructure

Now that the infrastructure configuration is defined it's time to launch it! In the same directory as your network and environment configuration files, run `beam up dev`. You should see output similar to below:

```yaml
$ beam up dev
Looking for changes...

+ Create VPC 10.0.0.0/16
    + Create internet gateway
    + Create key pair example_project-us-east-1
    + Create subnet 10.0.0.0/26 in us-east-1a
        + Create route table
            + Create route 0.0.0.0/0 through gateway beam:ig
        + Create example_project dev serial-1 development layer instance
            + Create 8GB SSD EBS volume attached to /dev/sda1

Are you sure you want to create and/or update resources in ec2 cloud in account example_project? (y/N)
```

`beam up dev` compares the local configuration with the currently running beam-controlled infrastructure in the cloud and shows you exactly what actions Beam needs to take to make your cloud infrastructure match the local configuration. Beam ignores any infrastructure it does not control. Beam tracks resources using AWS tagging, and on Rackspace, resource metadata.

The output of `beam up` is designed to be a readable diff with resource dependencies shown using indentation. Each line shows one action Beam will take.

In the output above there are a few actions Beam is going to take that are not defined in the configuration. Beam takes care of managing resources that are needed, such as internet gateways, based on configuration. In this case Beam is creating an internet gateway and subnet route because the publicAccessible attribute of the _public_ subnet was set to true. Additionally Beam will always create a key pair per region for each infrastructure project. The private key portion of this keypair is saved locally to `$HOME/.ssh/example_project-us-east-1-sandbox.pem`. The keypair is named based on the project configuration.

If everything looks good, type 'y' and press enter to execute the changes. Beam will output each action as it's completed like below:

```yaml

Executing: + Create VPC 10.0.0.0/16 OK
Executing: + Create internet gateway OK
Executing: + Create key pair example_project-us-east-1 OK
Executing: + Create subnet 10.0.0.0/26 in us-east-1a OK
Executing: + Create route table OK
Executing: + Create route 0.0.0.0/0 through gateway igw-5ff5fb3a OK
Executing: + Create example_project dev serial-1 development layer instance OK
Executing: + Create 8GB SSD EBS volume attached to /dev/sda1 OK
```

### Next

Congratulations! You now have a VPC with an EC2 instance running. In the next section we'll make [changes to the infrastructure](change.md).